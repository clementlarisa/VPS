let Produse = [
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2484,
        "NUME_PRODUS": "Samsung GALAXY J5 2017",
        "NAME": "Samsung GALAXY J5 2017 Negru 4G",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila, Mufa Jack",
        "Diagonala Ecran": "4.5-5 inch",
        "Camera": "Peste 12 MP",
        "Memorie interna": "16 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Magheru"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2719,
        "NUME_PRODUS": "Samsung GALAXY J5 2017",
        "NAME": "Samsung GALAXY J5 2017 Negru 4G",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila, Mufa Jack",
        "Diagonala Ecran": "4.5-5 inch",
        "Camera": "Peste 12 MP",
        "Memorie interna": "16 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Mihalache"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2822,
        "NUME_PRODUS": "Samsung GALAXY J5 2017",
        "NAME": "Samsung GALAXY J5 2017 Negru 4G",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila, Mufa Jack",
        "Diagonala Ecran": "4.5-5 inch",
        "Camera": "Peste 12 MP",
        "Memorie interna": "16 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Kaufland Colentina"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2925,
        "NUME_PRODUS": "Samsung GALAXY J5 2017",
        "NAME": "Samsung GALAXY J5 2017 Negru 4G",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila, Mufa Jack",
        "Diagonala Ecran": "4.5-5 inch",
        "Camera": "Peste 12 MP",
        "Memorie interna": "16 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Auchan Titan"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 3021,
        "NUME_PRODUS": "Samsung GALAXY J5 2017",
        "NAME": "Samsung GALAXY J5 2017 Negru 4G",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila, Mufa Jack",
        "Diagonala Ecran": "4.5-5 inch",
        "Camera": "Peste 12 MP",
        "Memorie interna": "16 GB",
        "Disponibil in magazin": "Magazin Vodafone - Constanta 1 Decembrie"
    }, {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 3117,
        "NUME_PRODUS": "Samsung GALAXY J5 2017",
        "NAME": "Samsung GALAXY J5 2017 Negru 4G",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila, Mufa Jack",
        "Diagonala Ecran": "4.5-5 inch",
        "Camera": "Peste 12 MP",
        "Memorie interna": "16 GB",
        "Disponibil in magazin": "Magazin Vodafone - Giurgiu"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2458,
        "NUME_PRODUS": "Samsung Galaxy S9",
        "NAME": "Samsung Galaxy S9 64 GB Negru 4.5G",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila,Incarcare Wireless , Rezistent la Apa , Mufa Jack",
        "Diagonala Ecran": "Peste 5.4inch",
        "Camera": "10-12 MP",
        "Memorie interna": "64 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Magheru"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2458,
        "NUME_PRODUS": "Samsung Galaxy S9",
        "NAME": "Samsung Galaxy S9 64 GB Negru 4.5G",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila,Incarcare Wireless , Rezistent la Apa , Mufa Jack",
        "Diagonala Ecran": "Peste 5.4inch",
        "Camera": "10-12 MP",
        "Memorie interna": "64 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Auchan Titan"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2458,
        "NUME_PRODUS": "Samsung Galaxy S9",
        "NAME": "Samsung Galaxy S9 64 GB Negru 4.5G",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila,Incarcare Wireless , Rezistent la Apa , Mufa Jack",
        "Diagonala Ecran": "Peste 5.4inch",
        "Camera": "10-12 MP",
        "Memorie interna": "64 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Kaufland Colentina"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2459,
        "NUME_PRODUS": "Samsung GALAXY S7",
        "NAME": "Samsung Galaxy S7 32 GB 4G+ Negru",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila,Incarcare Wireless , Rezistent la Apa , Mufa Jack",
        "Diagonala Ecran": "",
        "Camera": "",
        "Memorie interna": "32 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Magheru"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2460,
        "NUME_PRODUS": "Samsung Galaxy S9 Plus",
        "NAME": "Samsung Galaxy S9 Plus 64 GB Albastru Inchis 4G+",
        "Producator": "Samsung",
        "Caracteristici principale": "Senzor Amprenta, Memorie Expandabila,Incarcare Wireless , Rezistent la Apa , Mufa Jack",
        "Diagonala Ecran": "Peste 5.4inch",
        "Camera": "10-12 MP",
        "Memorie interna": "64 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Magheru"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2461,
        "NUME_PRODUS": "Vodafone Smart E8",
        "NAME": "Vodafone Smart E8 Albastru 4G",
        "Producator": "Vodafone",
        "Caracteristici principale": "Memorie Expandabila, Mufa Jack",
        "Diagonala Ecran": "4.5-5 inch",
        "Camera": "5-7.9 MP",
        "Memorie interna": "8 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Magheru"
    },
    {
        "DISPLAY_NAME": "Toate Telefoanele",
        "sku_id": 2462,
        "NUME_PRODUS": "iPhone X",
        "NAME": "iPhone�X 256GB Argintiu 4G+",
        "Producator": "Iphone",
        "Caracteristici principale": "Senzor Amprenta, Incarcare Wireless , Rezistent la Apa",
        "Diagonala Ecran": "Peste 5.4inch",
        "Camera": "10-12 MP",
        "Memorie interna": "Peste 64 GB",
        "Disponibil in magazin": "Magazin Vodafone - Bucuresti Magheru"
    }
];
let Locatii = [
    {
        "dealer_name": "Magazin Vodafone - Bucuresti Magheru",
        "city": "Bucuresti",
        "county": "Bucuresti",
        "address": "Bd.Magheru nr.2-4, Sector 1",
        "telefon": 720000350,
        "email": "VdfStoreBucharest-6_ro@vodafone.com",
        "luni": "09:00 - 19:30",
        "marti": "09:00 - 19:30",
        "miercuri": "09:00 - 19:30",
        "joi": "09:00 - 19:30",
        "vineri": "09:00 - 19:30",
        "sambata": "10:00 - 16:30",
        "duminica": "- - -",
        "latitudine": 44.44095,
        "longitudine": 26.10002,
        "profil_magazin": "magazin la strada",
        "cod_postal": "010282"
    },
    {
        "dealer_name": "Magazin Vodafone - Bucuresti Kaufland Colentina",
        "city": "Bucuresti",
        "county": "Bucuresti",
        "address": "Str.Colentina nr.6, Complex Comercial Kaufland, Sector 2",
        "telefon": 721126838,
        "email": "DL-FranchiseStoreBucurestiKauflandColentina@vodafo",
        "luni": "08:30 - 22:00",
        "marti": "08:30 - 22:00",
        "miercuri": "08:30 - 22:00",
        "joi": "08:30 - 22:00",
        "vineri": "08:30 - 22:00",
        "sambata": "08:30 - 22:00",
        "duminica": "09:00 - 20:00",
        "latitudine": 44.45387,
        "longitudine": 26.12992,
        "profil_magazin": "magazin in magazin (mall)",
        "cod_postal": "021173"
    },
    {
        "dealer_name": "Magazin Vodafone - Bucuresti Auchan Titan",
        "city": "Bucuresti",
        "county": "Bucuresti",
        "address": "Bd.1 Decembrie 1918 nr.33A, Complex Comercial Iris Auchan Titan, Sector 3",
        "telefon": 726114982,
        "email": "VodafoneStoreAuchan_ro@vodafone.com",
        "luni": "09:00 - 21:00",
        "marti": "09:00 - 21:00",
        "miercuri": "09:00 - 21:00",
        "joi": "09:00 - 21:00",
        "vineri": "09:00 - 21:00",
        "sambata": "09:00 - 21:00",
        "duminica": "09:00 - 21:00",
        "latitudine": 44.42085,
        "longitudine": 26.17819,
        "profil_magazin": "magazin in magazin (mall)",
        "cod_postal": "032533"
    },
    {
        "dealer_name": "Magazin Vodafone - Constanta 1 Decembrie",
        "city": "Constanta",
        "county": "Constanta",
        "address": "Bd.1 Decembrie 1918 nr.35, bl.L20, parter",
        "telefon": 722667299,
        "email": "franchiseStoreConstanta1Decembrie_ro@vodafone.com",
        "luni": "09:00 - 19:00",
        "marti": "09:00 - 19:00",
        "miercuri": "09:00 - 19:00",
        "joi": "09:00 - 19:00",
        "vineri": "09:00 - 19:00",
        "sambata": "09:00 - 15:00",
        "duminica": "inchis",
        "latitudine": 44.17758,
        "longitudine": 28.63566,
        "profil_magazin": "magazin la strada",
        "cod_postal": 900169
    },
    {
        "dealer_name": "Magazin Vodafone - Giurgiu",
        "city": "Bucuresti",
        "county": "Bucuresti",
        "address": "Sos.Giurgiului nr.127, Sector 4",
        "telefon": "0730708367",
        "email": "SayfoneBGiurgiului_ro@vodafone.com",
        "luni": "09:00 - 19:30",
        "marti": "09:00 - 19:30",
        "miercuri": "09:00 - 19:30",
        "joi": "09:00 - 19:30",
        "vineri": "09:00 - 19:30",
        "sambata": "09:00 - 15:00",
        "duminica": "- - -",
        "latitudine": 44.37981,
        "longitudine": 26.09235,
        "profil_magazin": "magazin la strada",
        "cod_postal": "040665"
    },
    {
        "dealer_name": "Magazin Vodafone - Bucuresti Mihalache",
        "city": "Bucuresti",
        "county": "Bucuresti",
        "address": "Bd.Ion Mihalache nr.107, Sector 1",
        "telefon": "0727433700",
        "email": "VodafoneStoreBucurestiMihalache_ro@vodafone.com",
        "luni": "09:00 - 19:30",
        "marti": "09:00 - 19:30",
        "miercuri": "09:00 - 19:30",
        "joi": "09:00 - 19:30",
        "vineri": "09:00 - 19:30",
        "sambata": "10:00 - 15:00",
        "duminica": "- - -",
        "latitudine": 44.46071,
        "longitudine": 26.0742,
        "profil_magazin": "magazin la strada",
        "cod_postal": "011176"
    },
    {
        "dealer_name": "Magazin Vodafone - Bucuresti Stefan cel Mare",
        "city": "Bucuresti",
        "county": "Bucuresti",
        "address": "Sos.Stefan cel Mare nr.4, bl.14, parter, Sector 1",
        "telefon": "0721122133",
        "email": "VodafoneStoreBucharest-8_ro@vodafone.com",
        "luni": "09:00 - 19:30",
        "marti": "09:00 - 19:30",
        "miercuri": "09:00 - 19:30",
        "joi": "09:00 - 19:30",
        "vineri": "09:00 - 19:30",
        "sambata": "10:00 - 15:00",
        "duminica": "- - -",
        "latitudine": 44.45302,
        "longitudine": 26.09957,
        "profil_magazin": "magazin la strada",
        "cod_postal": "011737"
    }
];

let App = {

    locatiiProdus: [],
    denumireProdus: '',
    imagineProdus: '',
    closestStoreMap: {},
    latitude: '',
    longitude: '',
    map: {},

    compareStrings: function (string1, string2) {
        string1 = string1.toLowerCase().replace('\s', '');
        string2 = string2.toLowerCase().replace('\s', '');
        return string1 === string2 ? true : false;
    },

    getLocationByDenumireProdus: function () {
        let that = this;
        $.each(Produse, function (i, listaProduse) {

            // console.log(that.denumireProdus +' => '+ listaProduse.NAME);

            if (that.compareStrings(that.denumireProdus, listaProduse.NAME)) {
                i = i + 1;
                that.locatiiProdus.push({
                    'denumire_magazin': listaProduse['Disponibil in magazin'],
                    'detalii_magazin': that.getDetailsByShopName(listaProduse['Disponibil in magazin'])
                });
            }
        });


        console.log("ma gasesti la",that.locatiiProdus);
    },

    getDetailsByShopName: function (denumireMagazin) {
        let that = this;
        let detalii = {};

        $.each(Locatii, function (i, listaMagazine) {
            if (that.compareStrings(denumireMagazin, listaMagazine['dealer_name'])) {

                detalii = listaMagazine;
            }
        })

        return detalii;
    },

    getLocation: function (success, fail) {

        let that = this;


        if (navigator.geolocation) {


            navigator.geolocation.getCurrentPosition(function (position) {

                if (typeof position.coords.latitude == "number") {

                    that.latitude = position.coords.latitude;
                    that.longitude = position.coords.longitude;
                    success();
                    return;

                } else {

                    console.log('Nu am gasit coordonatele');
                    console.log(position);

                }

            });

            fail();
        } else {
            console.log("Geolocation is not supported by this browser.");
        }
    },

    userFindsStoreOpen: function(shop, duration) {

        $("#lista-magazine").append("<li>" + shop['denumire_magazin'] + "</li>");
        var currentDate = new Date();
        var futureDate = new Date(currentDate.getTime() + (duration+15)*60000);

        var daysMap = {"0": "duminica", "1": "luni", "2": "marti", "3": "miercuri", "4": "joi", "5": "vineri", "6": "sambata"}
        var currentDay = daysMap[currentDate.getDay().toString()];
        var futureDay = daysMap[futureDate.getDay().toString()];
        if (currentDay !== futureDay) return false;
        var futureHour = futureDay.getHours();
        var futureMinute = futureDay.getMinutes();

        var openHours = shop.detalii_magazin[futureDay]
        var openingTime = openHours.split(' - ')[0];
        var closingTime = openHours.split(' - ')[1];
        if (openingTime === '-' || closingTime === '-') return false;

        var openingHour = openingTime.split(':')[0]
        var openingMinute = openingTime.split(':')[1]
        var closingHour = closingTime.split(':')[0]
        var closingMinute = closingTime.split(':')[1]

        if (openingHour > futureHour || closingHour < futureHour
            || (openingHour === futureHour && openingMinute > futureMinute)
            || (closingHour === futureHour && closingMinute < futureMinute)) {
            return false;
        }

        return true;
    },

    showButtonMap: function () {

        let $greyBoxGrid = $('.pick-a-plan');
        let denumireProdus = encodeURI($('h1#top-title').text().trim());
        let linkImagineProdus = encodeURI($('#piclarge').first().attr('src'));

        $greyBoxGrid
            .append(`
                <a class="button button-gaseste" href="/magazine-vodafone/index.htm?produs=${denumireProdus}&produs_img=${linkImagineProdus}" target="_blank"><span>Găsește-mă în magazin</span></a>
            `);
    },

    getRouteDuration: function (response) {
        let duration = 0;
        for (var i = 0; i < response.routes[0].legs.length; ++i) {
            duration = duration + response.routes[0].legs[i].duration.value;
        }

        return duration;
    },

    findFastestRoute: function (directionsService, callback) {

        let that = this;
        let fastest = null;
        var max = 999999;
        let myroutes = [];
        var closest = null;
        // console.log(that.locatiiProdus);
        for (let i = 0; i < that.locatiiProdus.length; ++i) {
            let shop_location_latitude = that.locatiiProdus[i]['detalii_magazin']['latitudine'];
            let shop_location_longitude = that.locatiiProdus[i]['detalii_magazin']['longitudine'];
            // var selectedMode = document.getElementById('mode').value;
            directionsService.route({
                origin: new google.maps.LatLng(that.latitude, that.longitude),
                destination: new google.maps.LatLng(shop_location_latitude, shop_location_longitude),
                // travelMode: google.maps.TravelMode[selectedMode],
                travelMode: google.maps.TravelMode["DRIVING"],
                region: 'ro'
            }, function (response, status) {
                var shop = that.locatiiProdus[i];
                if (status === 'OK') {
                    let duration = that.getRouteDuration(response);
                    callback(duration, response,shop);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }
        return closest;
    },

    showMap: function () {

        let that = this;
        // Get user's current location
        this.getLocation(function () {

            // LOCATIA A FOST GASITA

            let shop_location_latitude = that.locatiiProdus[0]['detalii_magazin']['latitudine'];
            let shop_location_longitude = that.locatiiProdus[0]['detalii_magazin']['longitudine'];

            let directionsService = new google.maps.DirectionsService;
            let directionsDisplay = new google.maps.DirectionsRenderer;

            that.map = new google.maps.Map(document.getElementById('product-map'), {
                zoom: 15,
                center: {
                    lat: shop_location_latitude,
                    lng: shop_location_longitude
                },
            });

            // ADD SHOPS MARKERS TO MAP
            var marker = null;
            for (let i = 0; i < that.locatiiProdus.length; i++) {
                {
                    marker = new google.maps.Marker({
                        position: {
                            lat: that.locatiiProdus[i]['detalii_magazin']['latitudine'],
                            lng: that.locatiiProdus[i]['detalii_magazin']['longitudine'],
                        },
                        map: that.map,
                        icon: "https://www.vodafone.ro/images/v182642.png"
                    });
                }}

            directionsDisplay.setMap(that.map);

            // FIND CLOSEST SHOP
            var closest = null;
            var min = 99999;
            let fastestRoute = that.findFastestRoute(directionsService, function (duration, response, shop) {

                // Check if user finds the store open
                // alert(shop.denumire_magazin + " IS OPEN: " + that.userFindsStoreOpen(shop, duration))
                that.userFindsStoreOpen(shop, duration)

                if (duration < min) {
                    min = duration;
                    closest = response;

                    directionsDisplay.setDirections(closest);
                    directionsDisplay.setPanel(document.getElementById('directions-panel'));

                    setTimeout(function(){
                        $("html, body").animate({ scrollTop: $('.bread-crumb').offset().top -120 }, 500);
                    },1000);
                }
            });

        }, function () {


            // LOCATIA NU A FOST DETECTATA

            let shop_location_latitude = that.locatiiProdus[0]['detalii_magazin']['latitudine'];
            let shop_location_longitude = that.locatiiProdus[0]['detalii_magazin']['longitudine'];

            that.map = new google.maps.Map(document.getElementById('product-map'), {
                zoom: 15,
                center: {
                    lat: shop_location_latitude,
                    lng: shop_location_longitude
                },
            });

            var marker = null;
            // console.log("locatii produs",that.locatiiProdus);
            for (let i = 0; i < that.locatiiProdus.length; i++) {
                {
                    marker = new google.maps.Marker({
                        position: {
                            lat: that.locatiiProdus[i]['detalii_magazin']['latitudine'],
                            lng: that.locatiiProdus[i]['detalii_magazin']['longitudine'],
                        },
                        map: that.map,
                        icon: "https://www.vodafone.ro/images/v182642.png"
                    });
                }}


        });


    },

    getUrlParameter: function () {
        var url = new URL(window.location.href);
        var c = url.searchParams.get("produs") || '';
        var c2 = url.searchParams.get("produs_img") || '';
        if (c.length > 1) {
            return {
                produs: c,
                produs_img: c2
            }
        } else {
            return false;
        }
    },

    init: function () {

        let that = this;

        $('#mode').change(that.showMap);

        $("#content").after("<div id='directions-panel'><p style='font-size: 32px'>Detalii de navigare: <br></p></div>");

        $("#footer").before("<div id='div-lista-magazine'><p class='lista-completa'>Vezi lista completa a magazinelor unde poti gasi produsul cautat</p><ol id='lista-magazine'></ol></div>");

        $('.lista-completa').click(function(){
            $('#lista-magazine').slideToggle();
        });

        // Pagina produs
        if ($('.pick-a-plan')) {

            // Get location by denumire produs
            this.denumireProdus = $('h1#top-title').text().trim();
            this.getLocationByDenumireProdus();

            if (this.locatiiProdus.length > 0) {
                this.showButtonMap();
            }

        }

        // Pagina harta
        if (this.getUrlParameter()) {

            this.denumireProdus = decodeURI(this.getUrlParameter().produs);
            this.imagineProdus = decodeURI(this.getUrlParameter().produs_img);

            // Redenumire h1
            $('h1.pad').html('Vino in cel mai apropiat magazin Vodafone deschis si testeaza<br />' + that.denumireProdus + '<hr />')
                .css({fontSize: '32px'});

            // Harta
            $('#content').html(`<div id="product-map"></div><img class="main-product-pic" src="${that.imagineProdus}" />`);

            this.getLocationByDenumireProdus();
            this.showMap();


        }
    }

};

App.init();